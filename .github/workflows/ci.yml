name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  quality-gates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install
        run: npm ci

      - name: Test suite
        run: npm test

      - name: Typecheck
        run: npx tsc --noEmit

      - name: Boundary guard
        run: npx vitest run tests/unit/architecture/domain-boundary-guard.test.ts

      - name: AP6 gate
        run: npm run test:ap6-gate

      - name: AP6 report verification
        run: npm run check:ap6-report

      - name: OpenAPI contract check
        run: npm run check:openapi

      - name: Protected route security parity
        run: npm run check:security-parity

      - name: Reason-code status map completeness
        run: npm run check:reason-code-map

      - name: No workflow shim imports in src
        run: npm run check:no-workflow-shim-imports

      - name: Schema preflight
        run: npm run check:schema-preflight

      - name: Release readiness
        run: npm run check:release-readiness

      - name: Environment matrix safety
        run: npm run check:env-matrix

      - name: W4 invariants
        run: npm run test:w4-invariants

      - name: Generate release checklist artifact
        run: npm run generate:release-checklist

      - name: Verify release checklist artifact
        run: npm run check:release-checklist

      - name: SDK drift check
        run: npm run check:sdk-drift

      - name: SDK smoke
        run: npm run test:sdk-smoke
